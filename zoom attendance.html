<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<title>ZoomAttendanceTool</title>
<link rel="stylesheet" href=""><style></style>
<script>window.onload=function() {
	//Cookie to hold rosters.
	//Check for cookie
	//document.cookie = "sdf=1;";
	// expire to hold cookies after session
	//"rosters=[\"Algebra2\":[\"Brown, Ben (BJ)\"] ; expires=Sun, 2 Jan 2022 12:00:00 UTC"; 
	//console.log(document.cookie);
	
	var output = document.getElementById("zoomOutput");
	var zoomInput = document.getElementById("zoomLog");
	var infiniteCampusOutput = document.getElementById("infiniteCampusOutput");
	var infiniteCampusInput = document.getElementById("infiniteCampusInput");
	var debug = document.getElementById("debug");

	//event handler binding
	zoomInput.oninput = suggestAttendance; //onchange requires focus loss
	//event handler for zoom paste
	function suggestAttendance() {
		// Get the text input and break into students
		var zoomReport = zoomInput.value;
		var students = zoomReport.split("\t");
		// Parse the string from each student
		var studentLists = students.map(parseStudent);
		function parseStudent(line) {
			var studentData = line.split(" ");
			var firstName = studentData[1];
			var lastNames = studentData.slice(2, studentData.length-1).join(" ");

			var minutes = studentData[studentData.length-1];
			return [firstName, lastNames, minutes];
		}
		// Sort by last name a-z
		var sortedStudents = studentLists.sort(byLastName);
		function byLastName(s1, s2){
			if (typeof s1[1] != "string"){return -1;} 
			else if (typeof s2[1] != "string"){return 1;} 
			else if (s1[1].toLowerCase() < s2[1].toLowerCase()){
				return -1;}
			else {return 1;}
		}
		debug.innerHTML = "";
		//firstNames = studentLists.map(function(s){return s[0];});
		sortedStudents.forEach(function (s){
			debug.innerHTML += s[s.length-1]+s[0]+" "+s[1]+"<br>";
		});
	}
	/***
	* Infinite Campus roster entry and output
	***/
	//event handler binding
	infiniteCampusInput.oninput = receiveRoster; //onchange requires focus loss
	//event handler for Infinite Campus roster paste
	function receiveRoster() {
		var rosterText = infiniteCampusInput.value;
		var allStudents = rosterText.split(/\d\d\d\d +[a-zA-Z]/);
		infiniteCampusOutput.innerHTML = allStudents;
		console.log(allStudents);
		var allStudentsLists = allStudents.map(parseInfiniteCampusRosterRow);
		function parseInfiniteCampusRosterRow(line) {
			// Last name goes up to the comma in rendered Infinite Campus roster view
			var studentData = line.split(",");
			var lastName = studentData[0];
			// Separate first name at tab, eat up space after comma
			studentData = studentData.slice(1,studentData.length).join(" ").split("\t ");
			var firstNames = studentData[0];
			// Parse and assign remaining data
			studentData = studentData[1].split(" "); //Error if no tab; loses unanticipated studentData[2:] if two tabs
			var sex = studentData[0]; //?labeled gender in InfC. Recoded for students switching pronouns?
			var gradeLevel = studentData[1];
			var birthdate = studentData[2];
			var additionalData = studentData.slice(3, studentData.length).join("\t");
			return [firstNames, lastName, sex, gradeLevel, birthdate, additionalData];
		}
		console.log(allStudentsLists);
		/*var sortedStudents = studentLists.sort(lastnamer);
		function lastnamer(a,b){
			if (typeof a[1] != "string"){return -1;} 
			else if (typeof b[1] != "string"){return 1;} 
			else if (a[1].toLowerCase() < b[1].toLowerCase()){
				return -1;}
			else {return 1;}
		}
		debug.innerHTML = "";
		//firstNames = studentLists.map(function(s){return s[0];});
		sortedStudents.forEach(function (s){
			debug.innerHTML += s[0]+" "+s[1]+"<br>";
		});*/
	}
};</script>
</head>
<body>


 <h1>Zoom attendance</h1>
 
 <form>
  <h1><label for="zoomInput">Paste Zoom Usage report ("Show unique users" checked):</label></h1> 
  <input type="text" id="zoomLog" name="zoomInput"><p>
No data will leave your computer, so this tool is FERPA compliant
even if the chat content becomes an educational record 
by virtue of being graded. 
Licensed Creative Commons Share-alike CC-SA-3.0 Bennett Brown
  <p>Output:
<p id="zoomOutput"> 
<p style="float: right;" id="infiniteCampusOutput">
	<h1><label for="infCRoster">Paste Infinite Campus roster here:</label>
	</h1> <input type="text" id="infiniteCampusInput" name="InfCRoster">
	<p> <button action="storeRoster();">Store roster</button>
	<button action="showRosters();">Show rosters</button>

</form>
<p style="float: none;" id="debug">
</body>
</html>